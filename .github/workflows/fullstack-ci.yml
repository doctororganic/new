name: Full Stack CI/CD

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: Install dependencies
      run: |
        cd new/backend
        go mod download
        go mod verify
        
    - name: Run tests
      run: |
        cd new/backend
        go test -v ./...
        
    - name: Build backend
      run: |
        cd new/backend
        go build -v ./cmd/server

    - name: Backend health check
      run: |
        cd new/backend
        nohup bash -lc "go run ./cmd/server/main.go" >/dev/null 2>&1 &
        sleep 2
        curl -f http://localhost:8080/health
        pkill -f "go run ./cmd/server/main.go" || true
        
    - name: Security scan
      uses: securecodewarrior/github-action-add-sarif@v1
      with:
        sarif-file: 'backend-security.sarif'
      continue-on-error: true

  frontend-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: new/frontend/package-lock.json
        
    - name: Install dependencies
      run: |
        cd new/frontend
        npm ci
        
    - name: Build frontend
      run: |
        cd new/frontend
        npm run build
        
    - name: Security audit
      run: |
        cd new/frontend
        npm audit --audit-level moderate

  integration-tests:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Docker Compose
      run: |
        docker-compose -f new/docker-compose.test.yml up -d
        sleep 30
        
    - name: Run integration tests
      run: |
        # Test backend endpoints
        curl -f http://localhost:8080/health || exit 1
        curl -f http://localhost:8080/api/status || exit 1
        
        # Test frontend
        curl -f http://localhost:3000 || exit 1
        
        # Smoke test flows
        chmod +x new/scripts/smoke.sh
        API_URL=http://localhost:8080 bash new/scripts/smoke.sh

    - name: Setup Node for e2e
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: new/frontend/package-lock.json

    - name: Install Playwright and deps
      run: |
        cd new/frontend
        npm ci || npm i
        npx playwright install --with-deps

    - name: Run Playwright e2e against compose
      env:
        BASE_URL: http://localhost:3000
        API_URL: http://localhost:8080
      run: |
        cd new/frontend
        npm run test:e2e
        
    - name: Cleanup
      run: |
        docker-compose -f new/docker-compose.test.yml down

  security-scan:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
      if: always()

  build-and-push:
    runs-on: ubuntu-latest
    needs: [integration-tests, security-scan]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Build and push backend
      uses: docker/build-push-action@v5
      with:
        context: ./new/backend
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/trae-backend:latest
          ${{ secrets.DOCKER_USERNAME }}/trae-backend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Build and push frontend
      uses: docker/build-push-action@v5
      with:
        context: ./new/frontend
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/trae-frontend:latest
          ${{ secrets.DOCKER_USERNAME }}/trae-frontend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /opt/trae-nutrition
          git pull origin main
          docker-compose pull
          docker-compose up -d
          
    - name: Health check
      run: |
        sleep 30
        curl -f ${{ secrets.SERVER_URL }}/health || exit 1
        curl -f ${{ secrets.SERVER_URL }}/api/v1/status || exit 1
